<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise Temporal | LIRAa Digital - Campina Grande</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- html2canvas + jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root { 
            --primary: #0e945c; 
            --primary-dark: #076e43;
            --danger: #d32f2f; 
            --warning: #fbc02d; 
            --safe: #2e7d32; 
            --bg-light: #f8f9fa;
        }
        
        body, html { 
            height: 100vh; margin: 0; overflow: hidden; 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            background: var(--bg-light); 
        }

        header { 
            display: flex; align-items: center; justify-content: space-between; 
            background: #ffffff; padding: 0 30px; height: 90px; 
            border-bottom: 4px solid var(--primary); 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 2000;
        }
        .logo-gat { display: flex; align-items: center; gap: 20px; }
        .logo-gat img { height: 140px; }
        .titulo-sistema h1 { margin: 0; font-size: 1.5rem; font-weight: 800; color: #1a1a1a; letter-spacing: -0.5px; }
        .titulo-sistema span { font-size: 0.85rem; font-weight: 500; color: #666; display: block; }

        .apoios { display: flex; align-items: center; gap: 25px; }
        .apoios img { 
            height: 50px; width: auto; 
            transition: transform 0.3s ease, opacity 0.3s; 
            filter: grayscale(20%);
        }
        .apoios img:hover { transform: scale(1.08); filter: grayscale(0%); opacity: 1; }

        nav { 
            background: var(--primary); 
            display: flex; padding: 0 10px; height: 40px; 
            align-items: center; z-index: 2000; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }
        nav a { 
            color: #ffffff !important; 
            text-decoration: none; margin-right: 30px;
            font-weight: 600; font-size: 0.85rem; 
            display: flex; align-items: center; gap: 8px;
            transition: 0.3s; opacity: 0.9; cursor: pointer;
            text-transform: uppercase;
        }
        nav a i { font-size: 1.1rem; color: #ffffff; }
        nav a:hover { opacity: 1; transform: translateY(-1px); text-shadow: 0 0 10px rgba(255,255,255,0.3); }
        /*nav a.active { background: rgba(0,0,0,0.15); border-radius: 4px; padding: 4px 10px; }*/
        nav a.active { border-bottom: 3px solid white; height: 100%; display: flex; align-items: center; opacity: 1; }

        #main-content {
            height: calc(100vh - 130px);
            overflow-y: auto;
            padding: 12px 20px; /* reduzido para ganhar espaço */
        }

        .controles {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 60px;
            margin: 8px 0 20px;
        }

        .form-group {
            text-align: center;
        }
        .form-group label {
            font-size: 0.78rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #555;
            margin-bottom: 6px;
            display: block;
        }

        /* Botões de indicador NO MESMO ESTILO e tamanho dos ciclos */
        #indicador-btns .btn {
            font-size: 0.875rem;          /* mesmo tamanho dos ciclos */
            padding: .25rem .75rem;       /* padrão btn-sm */
            font-weight: 600;
            min-width: 140px;             /* um pouco maior que ANO, mas equilibrado */
        }

        .mosaico-mapas {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px 8px;                 /* gap bem pequeno → colados, mosaico denso */
            max-width: 100%;
            margin: 0 auto;
        }

        .mapa-ano-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            border: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .mapa-ano-header {
            background: var(--primary);
            color: white;
            padding: 6px;
            font-weight: 700;
            text-align: center;
            font-size: 1rem;
        }

        .mini-map {
            flex: 1 1 auto;
            height: 100%;
            min-height: 160px;            /* menor mínimo para telas pequenas */
            background: #f8f9fa;
        }

        .resumo-status {
            padding: 6px 8px;
            display: flex;
            justify-content: space-around;
            font-size: 0.8rem;
            border-top: 1px solid #eee;
            background: #fcfcfc;
        }

        .status-item { text-align: center; }
        .status-item .numero {
            font-size: 1.25rem;
            font-weight: bold;
            line-height: 1.1;
        }
        .status-safe   { color: var(--safe); }
        .status-alerta { color: var(--warning); }
        .status-risco  { color: var(--danger); }

        .download-area {
            text-align: center;
            margin: 20px 0 30px;
        }

        @media (max-width: 1400px) {
            .mosaico-mapas { gap: 5px 7px; }
        }
        @media (max-width: 1200px) {
            .mosaico-mapas { grid-template-columns: repeat(4, 1fr); }
            .controles { gap: 40px; flex-wrap: wrap; }
        }
        @media (max-width: 992px) {
            .mosaico-mapas { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 768px) {
            .mosaico-mapas { grid-template-columns: repeat(2, 1fr); }
        }
    
    
    
    
    
    
    
    
    #export-container {
        position: absolute;
        left: -9999px; /* fora da tela */
        top: 0;
        width: 100%;
        background: white;
        padding: 20px;
        box-sizing: border-box;
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    .export-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #ffffff;
        padding: 0 30px;
        height: 90px;
        border-bottom: 4px solid var(--primary);
    }

    .export-titulo-figura {
        text-align: center;
        font-size: 1.6rem;
        font-weight: 700;
        color: var(--primary);
        margin: 20px 0 15px;
        padding: 0 20px;
    }

    .export-mosaico {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 4px 6px;
        max-width: 100%;
        margin: 0 auto;
    }

    /* Para garantir que os mini-maps capturados tenham tamanho decente na exportação */
    .export-mosaico .mapa-ano-card {
        height: auto !important;
    }
    .export-mosaico .mini-map {
        min-height: 260px !important; /* um pouco maior na exportação para legibilidade */
    }
    
    


    /*NOVO ESTILO*/

    /* Badge do Valor no canto superior direito */
.valor-indice-badge {
    position: absolute;
    top: 40px; /* logo abaixo do header do card */
    right: 8px;
    z-index: 1000;
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: 800;
    font-size: 1.1rem;
    color: white;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    pointer-events: none;
}

/* Info de Bairros no canto inferior esquerdo */
.bairros-visitados-info {
    position: absolute;
    bottom: 50px; /* acima do rodapé de status */
    left: 8px;
    z-index: 1000;
    font-size: 0.7rem;
    font-weight: 700;
    color: #444;
    background: rgba(255,255,255,0.8);
    padding: 1px 5px;
    border-radius: 3px;
    pointer-events: none;
}
    
    
    </style>
</head>
<body>

<header>
    <div class="logo-gat">
        <img src="https://lh3.googleusercontent.com/d/1CjAJykaxRU8iqYiCdiTD9fMkyLFWR7vx" alt="Logo LIRAa Digital">
        <div class="titulo-sistema">
            <h1>Vigilância Ambiental</h1>
            <span>Levantamento Rápido de Índices para Aedes aegypti em Campina Grande - PB</span>
        </div>
    </div>

    <div class="apoios">
        <a href="https://www.instagram.com/pet_saude_digital_ufcg/" target="_blank"><img src="https://lh3.googleusercontent.com/d/1Lvrvq6cCcIJgvLBSdi8u6B1SA75L9V_K" alt="PET-Saúde Digital"></a>
        <a href="https://gat-5.vercel.app/" target="_blank"><img src="https://lh3.googleusercontent.com/d/1fGEuRXpKXXiNafxDzFd0JDwwrVxKvd-a" alt="GAT-5"></a>
        <a href="https://saude.campinagrande.pb.gov.br/" target="_blank"><img src="https://lh3.googleusercontent.com/d/1vsaPX967sHVuynqPwLpFfktsO6s-_OZD" alt="Secretaria de Saúde"></a>
    </div>
</header>

<nav>
    <a href="index.html"><i class="bi bi-grid-1x2-fill"></i> Dashboard</a>
    <a class="active"><i class="bi bi-geo-fill"></i> Análise Temporal</a>
    <a href="relatorio.html"><i class="bi bi-file-earmark-text-fill"></i> Relatórios</a>
    <a href="sobre.html"><i class="bi bi-question-circle-fill"></i> Sobre</a>
</nav>

<div id="main-content">
    <div class="controles">
        <div class="form-group">
            <label>Indicador</label>
            <div id="indicador-btns" class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-success active" data-value="iip">Infestação Predial (IIP)</button>
                <button type="button" class="btn btn-outline-success" data-value="bre">Breteau (IB)</button>
                <button type="button" class="btn btn-outline-success" data-value="alb">Aedes Albopictus</button>
            </div>
        </div>

        <div class="form-group">
            <label>Ciclo de Levantamento</label>
            <div id="ciclo-btns" class="btn-group btn-group-sm" role="group"></div>
        </div>
    </div>

    <div class="mosaico-mapas" id="mosaico"></div>

    <div class="download-area">
        <button class="btn btn-primary me-4 px-4 py-2" id="btnPng"><i class="bi bi-download"></i> Baixar PNG</button>
        <button class="btn btn-success px-4 py-2" id="btnPdf"><i class="bi bi-file-earmark-pdf-fill"></i> Baixar PDF</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
const { jsPDF } = window.jspdf;
let state = {
    dados: {}, meta: {},
    indice: 'iip',
    ciclo: 'ANO',
    mapas: {}
};

const CORES = { 0: '#e0e0e0', safe: '#2e7d32', alerta: '#fbc02d', risco: '#d32f2f' };

function getCor(v) {
    if (v === 0 || !v) return CORES[0];
    return v < 1 ? CORES.safe : v < 4 ? CORES.alerta : CORES.risco;
}

async function carregarDados() {
    try {
        const res = await fetch("LIRAa Dados.xlsx");
        const wb = XLSX.read(await res.arrayBuffer(), { type: "array" });

        wb.SheetNames.forEach(name => {
            const ano = name.replace("LIRA_", "");
            const raw = XLSX.utils.sheet_to_json(wb.Sheets[name], { header: 1 });
            state.dados[ano] = {}; state.meta[ano] = [];

            let isPostF = false;
            raw.slice(1).forEach(row => {
                if (row[0] === 'F') { isPostF = true; return; }
                if (!isPostF && row[1]) {
                    const b = row[1].trim().toUpperCase();
                    state.dados[ano][b] = [];
                    for (let i = 2; i < row.length; i += 3) {
                        state.dados[ano][b].push({
                            iip: parseFloat(row[i]   || 0),
                            bre: parseFloat(row[i+1] || 0),
                            alb: parseFloat(row[i+2] || 0)
                        });
                    }
                } else if (isPostF && String(row[0]).startsWith('C')) {
                    state.meta[ano].push({ id: row[0], inicio: row[1], fim: row[2] });
                }
            });
        });

        initCiclos();
        renderMosaico();
    } catch(e) {
        console.error("Erro ao carregar dados:", e);
        document.getElementById('mosaico').innerHTML = '<p class="text-center text-danger mt-5">Erro ao carregar os dados do Excel.</p>';
    }
}

function initCiclos() {
    const container = document.getElementById("ciclo-btns");
    container.innerHTML = '';

    const btnAno = document.createElement('button');
    btnAno.className = `btn btn-sm ${state.ciclo==='ANO' ? 'btn-success' : 'btn-outline-secondary'} fw-bold px-4`;
    btnAno.textContent = 'ANO';
    btnAno.onclick = () => { state.ciclo = 'ANO'; updateCiclosUI(btnAno); renderMosaico(); };
    container.appendChild(btnAno);

    const anoExemplo = Object.keys(state.meta).sort().reverse()[0];
    (state.meta[anoExemplo] || []).forEach((c, idx) => {
        const btn = document.createElement('button');
        btn.className = `btn btn-sm ${state.ciclo===idx ? 'btn-success' : 'btn-outline-secondary'} fw-bold px-3`;
        btn.textContent = c.id;
        btn.onclick = () => { state.ciclo = idx; updateCiclosUI(btn); renderMosaico(); };
        container.appendChild(btn);
    });

    function updateCiclosUI(activeBtn) {
        container.querySelectorAll('.btn').forEach(b => b.classList.replace('btn-success', 'btn-outline-secondary'));
        activeBtn.classList.replace('btn-outline-secondary', 'btn-success');
    }
}

async function renderMosaico() {
    const container = document.getElementById('mosaico');
    container.innerHTML = '';

    const geoRes = await fetch("bairros_cg.geojson");
    const geojson = await geoRes.json();
    state.lastGeojson = geojson;

    const anosOrdenados = ['2015','2016','2017','2018','2019','2021','2022','2023','2024','2025'];

    for (const ano of anosOrdenados) {
        if (!state.dados[ano]) continue;

        const ciclosDoAno = state.meta[ano] || [];
        const semCiclo = state.ciclo !== 'ANO' && (!ciclosDoAno[state.ciclo]);

        let somaIndice = 0;
        let countBairrosComDados = 0;

        Object.keys(state.dados[ano]).forEach(bairro => {
    const d = state.dados[ano][bairro];
    let v = null;

    if (!semCiclo && d && d.length > 0) {
        if (state.ciclo === 'ANO') {
            let s = 0; d.forEach(c => s += c[state.indice] || 0);
            v = s / d.length;
        } else {
            v = d[state.ciclo] ? d[state.ciclo][state.indice] : null;
        }
        if (v !== null) {
            somaIndice += v;
            countBairrosComDados++;
        }
    }
});


        const mediaAno = countBairrosComDados > 0 ? (somaIndice / countBairrosComDados).toFixed(1) : "0.0";

        const card = document.createElement('div');
        card.className = 'mapa-ano-card';
        card.style.position = 'relative';
        card.innerHTML = `
            <div class="mapa-ano-header">${ano}</div>
            
            <div class="valor-indice-badge" style="background: ${getCor(parseFloat(mediaAno))}">${mediaAno}</div>
            
            <div id="map-${ano}" class="mini-map" style="${semCiclo ? 'filter: blur(3px);' : ''}"></div>
            
           ${semCiclo ? `<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:red;font-weight:bold;font-size:0.9rem;z-index:1000;">SEM CICLO</div>` : ''}


            <div class="bairros-visitados-info">Bairros: ${countBairrosComDados}</div>

            <div class="resumo-status">
                <div class="status-item status-safe"><div class="numero" id="s-${ano}">0</div><div>Satisfeito</div></div>
                <div class="status-item status-alerta"><div class="numero" id="a-${ano}">0</div><div>Alerta</div></div>
                <div class="status-item status-risco"><div class="numero" id="r-${ano}">0</div><div>Risco</div></div>
            </div>
        `;
        container.appendChild(card);

        const map = L.map(`map-${ano}`, {
            zoomControl: false,
            attributionControl: false,
            dragging: false,
            scrollWheelZoom: false,
            touchZoom: false
        });

        if (!semCiclo) {
                        let safe = 0, alerta = 0, risco = 0;
            const layer = L.geoJSON(geojson, {
                style: f => {
                    const b = f.properties.Name?.toUpperCase()?.trim();
                    const d = state.dados[ano]?.[b];
                    let v = null; // valor do índice

                    // --- Verifica se existe ciclo para este ano ---
                    const ciclosExistem = state.ciclo === 'ANO' || (state.meta[ano] && state.meta[ano][state.ciclo] !== undefined);

                    if (d && d.length > 0 && ciclosExistem) {
                        if (state.ciclo === 'ANO') {
                            let s = 0; d.forEach(ciclo => s += ciclo[state.indice] || 0);
                            v = s / d.length;
                        } else {
                            v = d[state.ciclo]?.[state.indice] ?? null;
                        }
                    }

                    // Só conta se realmente tiver valor
                    if (v !== null) {
                        if (v < 1) safe++;
                        else if (v < 4) alerta++;
                        else risco++;
                    }

                    return {
                        fillColor: (ciclosExistem ? getCor(v) : '#ccc'), // cinza embassado se não houver ciclo
                        weight: 0.8,
                        opacity: 1,
                        color: '#444',
                        fillOpacity: ciclosExistem ? 0.85 : 0.4 // embassado
                    };
                },
                onEachFeature: (f, layer) => {
                    const ciclosExistem = state.ciclo === 'ANO' || (state.meta[ano] && state.meta[ano][state.ciclo] !== undefined);
                    if (!ciclosExistem) {
                        layer.bindPopup(`<b>${f.properties.Name}</b><br><span style="color:red; font-weight:bold;">SEM CICLO</span>`);
                    }
                }
            }).addTo(map);

            map.fitBounds(layer.getBounds(), { padding: [4, 4] });

            document.getElementById(`s-${ano}`).textContent = safe;
            document.getElementById(`a-${ano}`).textContent = alerta;
            document.getElementById(`r-${ano}`).textContent = risco;
        } else {
            map.setView([ -7.2306, -35.8816 ], 12); // Centraliza Campina Grande
        }

        state.mapas[ano] = map;
    }
}


// Eventos dos botões de indicador
document.querySelectorAll('#indicador-btns .btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('#indicador-btns .btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.indice = btn.dataset.value;
        renderMosaico();
    });
});

// --- FUNÇÃO AUXILIAR PARA GERAR O MAPA EM SVG (SEM LEAFLET) ---
function gerarSvgMapa(ano) {
    const geojson = state.lastGeojson;
    if (!geojson) return '';

    const w = 300;
    const h = 250;

    // --- Verificação de Ciclo ---
    const ciclosDoAno = state.meta[ano] || [];
    const semCiclo = state.ciclo !== 'ANO' && (!ciclosDoAno[state.ciclo]);

    // Se não houver ciclo, retorna apenas o SVG com a mensagem, sem desenhar os caminhos
    if (semCiclo) {
        return `<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg" style="background:#f8f9fa;">
                    <text x="${w/2}" y="${h/2}" text-anchor="middle" fill="#d32f2f" font-size="20" font-weight="bold">SEM CICLO</text>
                </svg>`;
    }

    const coords = [];
    geojson.features.forEach(f => {
        if (f.geometry.type === 'Polygon') {
            f.geometry.coordinates[0].forEach(c => coords.push(c));
        } else if (f.geometry.type === 'MultiPolygon') {
            f.geometry.coordinates.forEach(poly => poly[0].forEach(c => coords.push(c)));
        }
    });

    const lons = coords.map(c => c[0]);
    const lats = coords.map(c => c[1]);
    const minLon = Math.min(...lons), maxLon = Math.max(...lons);
    const minLat = Math.min(...lats), maxLat = Math.max(...lats);

    const scale = Math.min(w / (maxLon - minLon), h / (maxLat - minLat)) * 0.9;
    const midLon = (minLon + maxLon) / 2;
    const midLat = (minLat + maxLat) / 2;

    const mapToSvg = (lon, lat) => {
        const x = (lon - midLon) * scale + w / 2;
        const y = h / 2 - (lat - midLat) * scale;
        return `${x},${y}`;
    };

    let caminhos = '';
    geojson.features.forEach(f => {
        const b = f.properties.Name?.toUpperCase()?.trim();
        const d = state.dados[ano]?.[b];
        let v = 0;

        if (d && d.length > 0) {
            v = state.ciclo === 'ANO'
                ? d.reduce((a, c) => a + (c[state.indice] || 0), 0) / d.length
                : (d[state.ciclo]?.[state.indice] || 0);
        }

        const pontos = f.geometry.type === 'Polygon' ? [f.geometry.coordinates] : f.geometry.coordinates;
        pontos.forEach(poly => {
            const pathData = poly[0].map(c => mapToSvg(c[0], c[1])).join(' L ');
            caminhos += `<path d="M ${pathData} Z" fill="${getCor(v)}" stroke="#444" stroke-width="0.5" />`;
        });
    });

    return `<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg" style="background:#f8f9fa;">${caminhos}</svg>`;
}


// --- DOWNLOADS CORRIGIDOS (VERSÃO SVG + AJUSTE DE CICLO) ---

async function prepararCapturaLimpa() {
    const exportDiv = document.createElement('div');
    exportDiv.style.width = '1200px';
    exportDiv.style.padding = '30px'; // Reduzi um pouco o padding global
    exportDiv.style.background = 'white';
    exportDiv.style.position = 'absolute';
    exportDiv.style.left = '-9999px';
    document.body.appendChild(exportDiv);
    

    // 1. Cabeçalho (Reduzindo logos para dar mais espaço)
    const headerClone = document.querySelector('header').cloneNode(true);
    headerClone.style.boxShadow = 'none';
    headerClone.style.height = '80px'; // Levemente menor
    exportDiv.appendChild(headerClone);

    // 2. Título (FONTE AJUSTADA PARA NÃO QUEBRAR)
    const nomesIndicadores = { 
        'iip': 'Infestação Predial (IIP)', 
        'bre': 'Índice de Breteau (IB)', 
        'alb': 'Aedes Albopictus' 
    };
    
    const titulo = document.createElement('h2');
    titulo.style.textAlign = 'center';
    titulo.style.margin = '25px 0'; // Menos margem vertical
    titulo.style.color = '#0e945c';
    titulo.style.fontSize = '1.4rem'; // Fonte reduzida para caber em uma linha
    titulo.style.fontWeight = '700';
    titulo.style.whiteSpace = 'nowrap'; // Garante que tente ficar em uma linha só
    
    // Ajuste do Ciclo: Exibindo como C1, C2...
    const textoCiclo = state.ciclo === 'ANO' ? '' : ` – Ciclo: C${Number(state.ciclo) + 1}`;
    titulo.textContent = `Análise Espacial: ${nomesIndicadores[state.indice]}${textoCiclo}`;
    exportDiv.appendChild(titulo);

    // 3. Mosaico de Mapas (Matriz 5x2)
    const mosaico = document.createElement('div');
    mosaico.style.display = 'grid';
    mosaico.style.gridTemplateColumns = 'repeat(5, 1fr)';
    mosaico.style.gap = '12px';

    const anosOrdenados = ['2015','2016','2017','2018','2019','2021','2022','2023','2024','2025'];
    anosOrdenados.forEach(ano => {
        if (!state.dados[ano]) return;
        
        let soma = 0, contBairros = 0;
const ciclosDoAno = state.meta[ano] || [];
const semCiclo = state.ciclo !== 'ANO' && (!ciclosDoAno[state.ciclo]);

Object.keys(state.dados[ano]).forEach(b => {
    const d = state.dados[ano][b];
    if (d && d.length > 0 && !semCiclo) { // só conta se existir ciclo
        contBairros++;
        let v = state.ciclo === 'ANO' 
            ? d.reduce((a, c) => a + (c[state.indice] || 0), 0) / d.length
            : (d[state.ciclo]?.[state.indice] || 0);
        soma += v;
    }
});


        const media = contBairros > 0 ? (soma / contBairros).toFixed(1) : "0.0";

        const card = document.createElement('div');
        card.style.cssText = "border:1px solid #ddd; border-radius:8px; overflow:hidden; display:flex; flex-direction:column; position:relative; background:white;";
        
        const resumo = document.getElementById(`s-${ano}`).parentElement.parentElement.cloneNode(true);
        resumo.style.fontSize = '0.7rem';

        card.innerHTML = `
            <div style="background:#0e945c; color:white; text-align:center; font-weight:bold; padding:4px; font-size: 0.9rem;">${ano}</div>
            <div style="position:absolute; top:35px; right:5px; background:${getCor(parseFloat(media))}; color:white; padding:2px 6px; border-radius:4px; font-weight:800; font-size:0.9rem; z-index:10;">${media}</div>
            <div style="height:180px; display:flex; align-items:center; justify-content:center; background:#f8f9fa;">
                ${gerarSvgMapa(ano)}
            </div>
            <div style="position:absolute; bottom:45px; left:5px; font-size:0.6rem; font-weight:bold; background:rgba(255,255,255,0.7); padding:1px 3px;">Bairros: ${contBairros}</div>
        `;
        card.appendChild(resumo);
        mosaico.appendChild(card);
    });

    exportDiv.appendChild(mosaico);

    const canvas = await html2canvas(exportDiv, { 
        scale: 2, 
        useCORS: true,
        logging: false 
    });
    document.body.removeChild(exportDiv);
    return canvas;
}

document.getElementById('btnPng').onclick = async () => {
    const canvas = await prepararCapturaLimpa();
    const link = document.createElement('a');
    link.download = `Mapa_LIRAa_${state.indice}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
};

document.getElementById('btnPdf').onclick = async () => {
    const canvas = await prepararCapturaLimpa();
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF('l', 'mm', 'a4');
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const imgProps = pdf.getImageProperties(imgData);
    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
    pdf.save(`Relatorio_LIRAa_${state.indice}.pdf`);
};

window.addEventListener('resize', () => {
    Object.values(state.mapas).forEach(m => m && m.invalidateSize());
});

carregarDados();
</script>
</body>
</html>